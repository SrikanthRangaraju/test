nohup bash -c 'while read -r line; do
  echo "Processing line: $line"
  rut="$(cut -d"," -f1 <<<"$line")"
  dv="$(cut -d"," -f2 <<<"$line")"

  attempt=0
  success=false

  while [ $attempt -lt 3 ]; do
    echo "Attempt $((attempt + 1)) for RUT: $rut"

    # Call the gRPC service and store the response in a temporary file
    grpcurl -emit-defaults -d "{
      \"rut\": \"$rut\",
      \"dv\": \"$dv\",
      \"period\": \"true\",
      \"segments\": [
        \"GENERAL\",
        \"SUMMARY\",
        \"BIENESRAICES\",
        \"DIRECCIONES\",
        \"ACTIVIDAD ECONOMICA\",
        \"DETALLE PROTESTOS MOROSIDAD\",
        \"REGULATED DATA\",
        \"CONTACTO EMPRESA\",
        \"MOROSIDADES BIC MAPPING\",
        \"RUT MAPPING\",
        \"CONSULTAS RUTMAPPING\",
        \"QUIEBRAS\",
        \"SOCIOSOCIEDADES\",
        \"TELEFONO\",
        \"VEHICULOS\",
        \"PRE CALCULATED ATTRIBUTES REGULATED\",
        \"PRE CALCULATED ATTRIBUTES NONREGULATED\",
        \"SABOE\",
        \"SABCDE\",
        \"SAMCDEN\",
        \"SADDRIN\",
        \"PERDAS LIST\",
        \"CHILE AUT\",
        \"CHILE GIROS\",
        \"CHILE RRCC\",
        \"CHILE MAIL\",
        \"CHILE MCC\",
        \"CHILE PER\",
        \"CHILE DIR\",
        \"CHILE MTU\",
        \"CHILE BRA\",
        \"CHILE BIC\",
        \"CHILE RELPAR\",
        \"CHILE RUTAN\",
        \"ANOTACIONES DATA DETALLE\"
      ],
      \"monitoringDate\": \"20231130\"
    }" -insecure localhost:22022 com.chile.grpc.getData.model.GetDataService/getData > "RutResponse/$rut.json" 2>> grpc_errors.log

    # Check if the gRPC command succeeded
    if [ $? -eq 0 ]; then
      # Check the response content for error codes
      if grep -q "\"response_code\":500" "RutResponse/$rut.json"; then
        echo "gRPC response indicates failure for $rut. Retrying..." >> grpc_errors.log
      else
        echo "gRPC call succeeded with valid response for $rut"
        success=true
        break
      fi
    else
      echo "gRPC call failed for $rut. Retrying..." >> grpc_errors.log
    fi

    attempt=$((attempt + 1))
    sleep 2
  done

  if [ "$success" = false ]; then
    echo "Failed to process $rut after 3 attempts." >> failed_lines.txt
  fi
done < testData.txt > output.log 2>&1 &'
