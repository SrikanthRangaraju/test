#!/bin/bash

BYTEARRAY_DIR="./byteArray"
OUTPUT_CSV="./feature_output.csv"
GRPC_URL="888.9999"
SERVICE="o.oc.service.some"
AUTH_TOKEN="mysomtoken"

echo "fn,fn,cccc" > "$OUTPUT_CSV"

for file in "$BYTEARRAY_DIR"/123_*.txt; do
  echo "Processing $file..."

  line=$(cat "$file")
  aA=$(echo "$line" | sed -n 's/.*"aA":"\([^"]*\)".*/\1/p')
  bB=$(echo "$line" | sed -n 's/.*"bB":"\([^"]*\)".*/\1/p')

  read -r -d '' body <<EOF
{
  "requestHeader": {
   
  },
  "sD": {
    "abc": "$accc",
    "def": "$dsdsdsdsdsd"
  },
  "somethingsomarray": [
    {
      
    },
    {
      
    }
  ]
}
EOF

  response=$(grpcurl -plaintext -H "authorization: Bearer $AUTH_TOKEN" -d "$body" "$GRPC_URL" "$SERVICE")

  echo "$response" | jq -r --arg fname "$(basename "$file")" '
    .somout[]?.resp1[]? | [$name, .hello, .world] | @csv
  ' >> "$OUTPUT_CSV"
done

echo "âœ… Done. CSV written to $OUTPUT_CSV"
